{
  "permissions": {
    "messages": {
      "row": {
        "select": [
          [
            "allow",
            {
              "type": "correlatedSubquery",
              "related": {
                "system": "permissions",
                "correlation": {
                  "parentField": [
                    "conversation_id"
                  ],
                  "childField": [
                    "id"
                  ]
                },
                "subquery": {
                  "table": "conversations",
                  "alias": "zsubq_conversation",
                  "where": {
                    "type": "or",
                    "conditions": [
                      {
                        "type": "and",
                        "conditions": [
                          {
                            "type": "simple",
                            "left": {
                              "type": "static",
                              "anchor": "authData",
                              "field": "sub"
                            },
                            "right": {
                              "type": "literal",
                              "value": null
                            },
                            "op": "IS NOT"
                          },
                          {
                            "type": "simple",
                            "left": {
                              "type": "column",
                              "name": "user_id"
                            },
                            "right": {
                              "type": "static",
                              "anchor": "authData",
                              "field": "sub"
                            },
                            "op": "="
                          }
                        ]
                      },
                      {
                        "type": "simple",
                        "left": {
                          "type": "column",
                          "name": "access_level"
                        },
                        "right": {
                          "type": "literal",
                          "value": "public_read"
                        },
                        "op": "="
                      },
                      {
                        "type": "simple",
                        "left": {
                          "type": "column",
                          "name": "access_level"
                        },
                        "right": {
                          "type": "literal",
                          "value": "public_write"
                        },
                        "op": "="
                      }
                    ]
                  },
                  "orderBy": [
                    [
                      "id",
                      "asc"
                    ]
                  ]
                }
              },
              "op": "EXISTS"
            }
          ]
        ],
        "update": {},
        "delete": [
          [
            "allow",
            {
              "type": "correlatedSubquery",
              "related": {
                "system": "permissions",
                "correlation": {
                  "parentField": [
                    "conversation_id"
                  ],
                  "childField": [
                    "id"
                  ]
                },
                "subquery": {
                  "table": "conversations",
                  "alias": "zsubq_conversation",
                  "where": {
                    "type": "and",
                    "conditions": [
                      {
                        "type": "simple",
                        "left": {
                          "type": "static",
                          "anchor": "authData",
                          "field": "sub"
                        },
                        "right": {
                          "type": "literal",
                          "value": null
                        },
                        "op": "IS NOT"
                      },
                      {
                        "type": "simple",
                        "left": {
                          "type": "column",
                          "name": "user_id"
                        },
                        "right": {
                          "type": "static",
                          "anchor": "authData",
                          "field": "sub"
                        },
                        "op": "="
                      }
                    ]
                  },
                  "orderBy": [
                    [
                      "id",
                      "asc"
                    ]
                  ]
                }
              },
              "op": "EXISTS"
            }
          ]
        ]
      }
    },
    "message_chunks": {
      "row": {
        "select": [
          [
            "allow",
            {
              "type": "correlatedSubquery",
              "related": {
                "system": "permissions",
                "correlation": {
                  "parentField": [
                    "message_id"
                  ],
                  "childField": [
                    "id"
                  ]
                },
                "subquery": {
                  "table": "messages",
                  "alias": "zsubq_message",
                  "where": {
                    "type": "correlatedSubquery",
                    "related": {
                      "system": "permissions",
                      "correlation": {
                        "parentField": [
                          "conversation_id"
                        ],
                        "childField": [
                          "id"
                        ]
                      },
                      "subquery": {
                        "table": "conversations",
                        "alias": "zsubq_conversation",
                        "where": {
                          "type": "or",
                          "conditions": [
                            {
                              "type": "and",
                              "conditions": [
                                {
                                  "type": "simple",
                                  "left": {
                                    "type": "static",
                                    "anchor": "authData",
                                    "field": "sub"
                                  },
                                  "right": {
                                    "type": "literal",
                                    "value": null
                                  },
                                  "op": "IS NOT"
                                },
                                {
                                  "type": "simple",
                                  "left": {
                                    "type": "column",
                                    "name": "user_id"
                                  },
                                  "right": {
                                    "type": "static",
                                    "anchor": "authData",
                                    "field": "sub"
                                  },
                                  "op": "="
                                }
                              ]
                            },
                            {
                              "type": "simple",
                              "left": {
                                "type": "column",
                                "name": "access_level"
                              },
                              "right": {
                                "type": "literal",
                                "value": "public_read"
                              },
                              "op": "="
                            },
                            {
                              "type": "simple",
                              "left": {
                                "type": "column",
                                "name": "access_level"
                              },
                              "right": {
                                "type": "literal",
                                "value": "public_write"
                              },
                              "op": "="
                            }
                          ]
                        },
                        "orderBy": [
                          [
                            "id",
                            "asc"
                          ]
                        ]
                      }
                    },
                    "op": "EXISTS"
                  },
                  "orderBy": [
                    [
                      "id",
                      "asc"
                    ]
                  ]
                }
              },
              "op": "EXISTS"
            }
          ]
        ],
        "update": {}
      }
    },
    "conversations": {
      "row": {
        "select": [
          [
            "allow",
            {
              "type": "or",
              "conditions": [
                {
                  "type": "and",
                  "conditions": [
                    {
                      "type": "simple",
                      "left": {
                        "type": "static",
                        "anchor": "authData",
                        "field": "sub"
                      },
                      "right": {
                        "type": "literal",
                        "value": null
                      },
                      "op": "IS NOT"
                    },
                    {
                      "type": "simple",
                      "left": {
                        "type": "column",
                        "name": "user_id"
                      },
                      "right": {
                        "type": "static",
                        "anchor": "authData",
                        "field": "sub"
                      },
                      "op": "="
                    }
                  ]
                },
                {
                  "type": "simple",
                  "left": {
                    "type": "column",
                    "name": "access_level"
                  },
                  "right": {
                    "type": "literal",
                    "value": "public_read"
                  },
                  "op": "="
                },
                {
                  "type": "simple",
                  "left": {
                    "type": "column",
                    "name": "access_level"
                  },
                  "right": {
                    "type": "literal",
                    "value": "public_write"
                  },
                  "op": "="
                }
              ]
            }
          ]
        ],
        "update": {
          "preMutation": [
            [
              "allow",
              {
                "type": "and",
                "conditions": [
                  {
                    "type": "simple",
                    "left": {
                      "type": "static",
                      "anchor": "authData",
                      "field": "sub"
                    },
                    "right": {
                      "type": "literal",
                      "value": null
                    },
                    "op": "IS NOT"
                  },
                  {
                    "type": "simple",
                    "left": {
                      "type": "column",
                      "name": "user_id"
                    },
                    "right": {
                      "type": "static",
                      "anchor": "authData",
                      "field": "sub"
                    },
                    "op": "="
                  }
                ]
              }
            ]
          ],
          "postMutation": [
            [
              "allow",
              {
                "type": "and",
                "conditions": [
                  {
                    "type": "simple",
                    "left": {
                      "type": "static",
                      "anchor": "authData",
                      "field": "sub"
                    },
                    "right": {
                      "type": "literal",
                      "value": null
                    },
                    "op": "IS NOT"
                  },
                  {
                    "type": "simple",
                    "left": {
                      "type": "column",
                      "name": "user_id"
                    },
                    "right": {
                      "type": "static",
                      "anchor": "authData",
                      "field": "sub"
                    },
                    "op": "="
                  }
                ]
              }
            ]
          ]
        },
        "delete": [
          [
            "allow",
            {
              "type": "and",
              "conditions": [
                {
                  "type": "simple",
                  "left": {
                    "type": "static",
                    "anchor": "authData",
                    "field": "sub"
                  },
                  "right": {
                    "type": "literal",
                    "value": null
                  },
                  "op": "IS NOT"
                },
                {
                  "type": "simple",
                  "left": {
                    "type": "column",
                    "name": "user_id"
                  },
                  "right": {
                    "type": "static",
                    "anchor": "authData",
                    "field": "sub"
                  },
                  "op": "="
                }
              ]
            }
          ]
        ]
      }
    }
  },
  "schema": {
    "version": 1,
    "tables": {
      "conversations": {
        "name": "conversations",
        "columns": {
          "id": {
            "type": "string",
            "optional": false,
            "customType": null
          },
          "userId": {
            "type": "string",
            "optional": false,
            "customType": null,
            "serverName": "user_id"
          },
          "title": {
            "type": "string",
            "optional": false,
            "customType": null
          },
          "accessLevel": {
            "type": "string",
            "optional": true,
            "customType": null,
            "serverName": "access_level"
          },
          "createdAt": {
            "type": "number",
            "optional": true,
            "customType": null,
            "serverName": "created_at"
          },
          "updatedAt": {
            "type": "number",
            "optional": true,
            "customType": null,
            "serverName": "updated_at"
          }
        },
        "primaryKey": [
          "id"
        ]
      },
      "messageChunks": {
        "name": "messageChunks",
        "columns": {
          "id": {
            "type": "number",
            "optional": true,
            "customType": null
          },
          "messageId": {
            "type": "number",
            "optional": false,
            "customType": null,
            "serverName": "message_id"
          },
          "chunkIndex": {
            "type": "number",
            "optional": false,
            "customType": null,
            "serverName": "chunk_index"
          },
          "content": {
            "type": "string",
            "optional": false,
            "customType": null
          },
          "createdAt": {
            "type": "number",
            "optional": true,
            "customType": null,
            "serverName": "created_at"
          }
        },
        "primaryKey": [
          "id"
        ],
        "serverName": "message_chunks"
      },
      "messages": {
        "name": "messages",
        "columns": {
          "id": {
            "type": "number",
            "optional": true,
            "customType": null
          },
          "conversationId": {
            "type": "string",
            "optional": false,
            "customType": null,
            "serverName": "conversation_id"
          },
          "sender": {
            "type": "string",
            "optional": false,
            "customType": null
          },
          "isFinal": {
            "type": "boolean",
            "optional": true,
            "customType": null,
            "serverName": "is_final"
          },
          "finalText": {
            "type": "string",
            "optional": true,
            "customType": null,
            "serverName": "final_text"
          },
          "createdAt": {
            "type": "number",
            "optional": true,
            "customType": null,
            "serverName": "created_at"
          },
          "updatedAt": {
            "type": "number",
            "optional": true,
            "customType": null,
            "serverName": "updated_at"
          }
        },
        "primaryKey": [
          "id"
        ]
      }
    },
    "relationships": {
      "conversations": {
        "messages": [
          {
            "sourceField": [
              "id"
            ],
            "destField": [
              "conversationId"
            ],
            "destSchema": "messages",
            "cardinality": "many"
          }
        ]
      },
      "messageChunks": {
        "message": [
          {
            "sourceField": [
              "messageId"
            ],
            "destField": [
              "id"
            ],
            "destSchema": "messages",
            "cardinality": "one"
          }
        ]
      },
      "messages": {
        "conversation": [
          {
            "sourceField": [
              "conversationId"
            ],
            "destField": [
              "id"
            ],
            "destSchema": "conversations",
            "cardinality": "one"
          }
        ],
        "messageChunks": [
          {
            "sourceField": [
              "id"
            ],
            "destField": [
              "messageId"
            ],
            "destSchema": "messageChunks",
            "cardinality": "many"
          }
        ]
      }
    }
  }
}